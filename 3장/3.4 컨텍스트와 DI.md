# 3.4 | 컨텍스트와 DI
## 3.4.1 | JdbcContext의 분리
* 클라이언트: User의 메소드
* 컨텍스트 메소드: UserDao 내의 PreparedStatement를 실행하는 기능을 가진 메소드에서 공유 가능
* 개별적인 전략: 익명 내부 클래스로 만들어지는 것

* * *
### 클래스 분리
* JdbcContext라는 클래스를 새로 만들어 분리
설명) UserDao에 있던 컨텍스트 메소드를 workWithStatementStrategy()라는 이름으로 JdbcContext에 옮긴다. but, 이렇게 하면 DataSource가 필요한 것은 UserDao가 아닌 JdbcContext가 돼 버림. DB커넥션을 필요로 하는 코드는 JdbcContext안에 있기 때문
따라서 JdbcContext가 DataSource에 의존하고 있으므로 DataSource 타입 빈을 DI받을 수 있게 해줘야 한다.
*여기수정

> **JDBC 작업 흐름을 분리해서 만든 JdbcContext클래스**
```
package springbook.user.dao;
. . .
public class JdbcContext{
  //DataSource타입 빈을 DI 받을 수 있게 준비해둔다.
	private DataSource dataSource; 
	
  public void setDataSource(DataSource dataSource) {
		this.dataSource = dateSource;
}

//JdbcContext 클래스 안으로 옮겼으므로 이름도 그에 맞게 수정
public void workWithStatementStrategy(StatementStrategy stmt) throws SQLException {
  Connection c = null;
  PreparedStatement ps = null;
  
  try{
    c = this.dataSource.getConnection();
    ps = stmt.makePreparedStatement(c);
    ps.executeUpdate();
   } catch (SQLException e){
    throw e;
   } finally {
     if (ps != null) {try {ps.clode();} catch (SQLException e) {} }
     if (c != null) {try {c.close();} catch (SQLException e) {} }
   }
  }
}
```
> **JdbcContext를 DI받아서 사용하도록 만든 UserDao**
> * UserDao가 분리된 JdbcContext를 DI받아서 사용할 수 있게 수정
```
public class UserDao {
  . . .
  private JdbcContext jdbcContext;
  public void setJdbcContext(JdbcContext jdbcContext){
    this.jdbcContext = jdbcContext ;
  }
	
  public void add (final User user) throws SQLException{
    this.jdbcContext.workWithStatementStrategy(
      new StatementStrategy() { . . . }
    );
  }//??오타수정
  public void deleteAll() throw SWLExcpetion{
	  this.jdbc.Context.workWithStatementStrategy(
      new StatementStrategy() { . . . }
    );
  }
  . . .
```

* * *
* 빈 의존관계 변경
새롭게 작성된 의존 관계 : UserDao는 이제 JdbcContext에 의존하지만 이 JdbcContext는 인터페이스가 아닌 구체클래스
*??????추가*
> **그림 3-5의 빈 의존관계를 따라서 XML파일(text-applicationContext.xml) 수정**
```
<?xml version=”1.0” encoding=”UTF-8”?>
<beans xmlns=http://www.springframework.org/schema/beans
xmlns:xsi=http://www.w3.org/2001/XMLSchema-instance
xsi:schemaLocation=“http://www.springframework.org/schema/beans
 http://www.springframwork.org/schema/beans/spring-beans.xsd”>

<bean id=”userDao” class=”springbook.user.dao.UserDao”>
	//UserDao내에 아직 JdbcConext를 적용하지 않은 메소드가 있어서 제거하지 않음
<property name=”dataSource” ref=”dataSource” />
<property name=”jdbcContext” ref=”jdbcContext” />
</bean>

<bean id=”jdbcContext” class=”springbook.user.dao.JdbcContext”>
<property name=”dataSource” ref=”dataSource” />
</bean>

<bean id=”dataSource”
	class=”org.springframework.jdbc.dataSource.SimpleDriverDataSource” >
	// . . .
</bean>
</beans>
```
